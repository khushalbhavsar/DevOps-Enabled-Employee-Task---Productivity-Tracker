pipeline {
    agent any
    environment {
        DOCKER_IMAGE_BACKEND = 'productivity-backend'
        DOCKER_IMAGE_FRONTEND = 'productivity-frontend'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_HUB_CREDENTIALS = 'dockerhub-credentials'
        SONARQUBE_HOST = 'http://sonarqube:9000'
        SONARQUBE_CREDENTIALS = 'sonarqube-token'
        K8S_NAMESPACE = 'productivity-tracker'
        K8S_DEPLOYMENT_BACKEND = 'backend'
        K8S_DEPLOYMENT_FRONTEND = 'frontend'
        KUBECONFIG = credentials('kubeconfig')
        DEPLOY_TARGET = 'k8s' // Change to 'docker' for Docker deployment
    }
    stages {
        stage('Clone Repository') {
            steps {
                checkout scm
                echo '‚úÖ Code cloned from GitHub'
            }
        }
        stage('SonarQube Analysis') {
            steps {
                script {
                    echo 'üîç Running SonarQube analysis...'
                    withCredentials([string(credentialsId: env.SONARQUBE_CREDENTIALS, variable: 'SONAR_TOKEN')]) {
                        sh """
                            docker run --rm \
                                --network host \
                                -e SONAR_HOST_URL='${SONARQUBE_HOST}' \
                                -e SONAR_TOKEN='$SONAR_TOKEN' \
                                -v "${WORKSPACE}:/usr/src" \
                                sonarsource/sonar-scanner-cli \
                                -Dsonar.projectKey=employee-productivity-tracker \
                                -Dsonar.sources=backend/src,frontend/src \
                                -Dsonar.sourceEncoding=UTF-8
                        """
                    }
                }
            }
        }
        stage('Build Docker Images') {
            steps {
                script {
                    echo 'üèóÔ∏è Building Docker images...'
                    sh """
                        docker build -t ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} backend
                        docker build -t ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} frontend
                    """
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    if (env.DEPLOY_TARGET == 'k8s') {
                        echo 'üöÄ Deploying to Kubernetes...'
                        sh """
                            kubectl apply -f kubernetes/deployments/backend-deployment.yaml -n ${K8S_NAMESPACE}
                            kubectl apply -f kubernetes/deployments/frontend-deployment.yaml -n ${K8S_NAMESPACE}
                        """
                    } else {
                        echo 'üöÄ Deploying with Docker...'
                        sh """
                            docker run -d --name backend -p 5000:5000 ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}
                            docker run -d --name frontend -p 3000:3000 ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}
                        """
                    }
                }
            }
        }
        stage('Grafana & Prometheus Info') {
            steps {
                echo 'üìä Grafana: http://localhost:3001 (admin/admin)'
                echo 'üìà Prometheus: http://localhost:9090'
            }
        }
    }
    post {
        always {
            echo 'üßπ Cleaning up...'
        }
        success {
            echo '‚úÖ Pipeline completed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed! Check logs for details.'
        }
    }
}
