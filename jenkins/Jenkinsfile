pipeline {
    agent any
    environment {
        DOCKER_IMAGE = "todoapp-nodejs"
        DOCKER_TAG = "${BUILD_NUMBER}"
        REGISTRY_CREDENTIALS = "docker-hub-cred"
        SONARQUBE_CREDENTIALS = "sonarqube-token"
        SONARQUBE_HOST = "http://54.90.132.250:9000"
        K8S_NAMESPACE = "todoapp"
        K8S_DEPLOYMENT = "todoapp-deployment"
        DEPLOY_TARGET = "docker-compose" // Options: "docker" or "k8s"
    }
    stages {
        stage('SonarQube Analysis') {
            steps {
                script {
                    try {
                        echo "ğŸ” Running SonarQube code analysis..."
                        withCredentials([string(credentialsId: "${SONARQUBE_CREDENTIALS}", variable: 'SONAR_TOKEN')]) {
                            sh """
                                docker run --rm \
                                    --network host \
                                    -e SONAR_HOST_URL=\"${SONARQUBE_HOST}\" \
                                    -e SONAR_TOKEN=\"$SONAR_TOKEN\" \
                                    -v \"${WORKSPACE}:/usr/src\" \
                                    sonarsource/sonar-scanner-cli \
                                    -Dsonar.projectKey=todoapp-nodejs \
                                    -Dsonar.projectName='TodoApp Node.js Pipeline' \
                                    -Dsonar.projectVersion=1.0 \
                                    -Dsonar.sources=. \
                                    -Dsonar.exclusions='**/node_modules/**,**/coverage/**,**/k8s/**,**/*.md,**/grafana/**' \
                                    -Dsonar.javascript.file.suffixes=.js \
                                    -Dsonar.sourceEncoding=UTF-8
                            """
                        }
                        echo "âœ… SonarQube analysis completed"
                    } catch (Exception e) {
                        echo "âš ï¸ SonarQube analysis skipped: ${e.message}"
                        echo "ğŸ’¡ Check: 1) SonarQube server is running 2) Credential 'sonarqube-token' exists"
                        echo "â„¹ï¸ SonarQube URL: ${SONARQUBE_HOST}"
                    }
                }
            }
        }
        stage('Quality Gate') {
            steps {
                echo "âœ… SonarQube analysis completed - Quality Gate check skipped (using Docker scanner)"
                echo "ğŸ’¡ Visit ${SONARQUBE_HOST} to view detailed analysis results"
            }
        }
        stage("Code Build & Test") {
            steps {
                echo "ğŸ—ï¸ Building Docker image..."
                script {
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
                echo "âœ… Build completed successfully"
            }
        }
        stage("Push To DockerHub") {
            steps {
                script {
                    try {
                        echo "ğŸ” Authenticating with Docker Hub..."
                        withCredentials([usernamePassword(
                            credentialsId: "${REGISTRY_CREDENTIALS}",
                            usernameVariable: "DOCKER_USER", 
                            passwordVariable: "DOCKER_PASS")]) {
                            sh """
                                echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                                docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} $DOCKER_USER/${DOCKER_IMAGE}:${DOCKER_TAG}
                                docker tag ${DOCKER_IMAGE}:latest $DOCKER_USER/${DOCKER_IMAGE}:latest
                                docker push $DOCKER_USER/${DOCKER_IMAGE}:${DOCKER_TAG}
                                docker push $DOCKER_USER/${DOCKER_IMAGE}:latest
                            """
                        }
                        echo "âœ… Images pushed to Docker Hub successfully"
                    } catch (Exception e) {
                        echo "âš ï¸ Docker Hub push skipped: ${e.message}"
                        echo "ğŸ’¡ To enable: Create credential 'docker-hub-cred' in Jenkins"
                        echo "â„¹ï¸ Local image '${DOCKER_IMAGE}:${DOCKER_TAG}' is available for deployment"
                    }
                }
            }
        }
        stage("Deploy") {
            steps {
                script {
                    if (env.DEPLOY_TARGET == "k8s") {
                        echo "ğŸš€ Deploying to Kubernetes..."
                        sh """
                            sed -i 's|image: khushalbhavsar/${DOCKER_IMAGE}:.*|image: khushalbhavsar/${DOCKER_IMAGE}:${DOCKER_TAG}|g' k8s/deployment.yaml
                            kubectl apply -f k8s/namespace.yaml
                            kubectl apply -f k8s/configmap.yaml
                            kubectl apply -f k8s/deployment.yaml
                            kubectl apply -f k8s/service.yaml
                            kubectl apply -f k8s/hpa.yaml
                            kubectl rollout status deployment/${K8S_DEPLOYMENT} -n ${K8S_NAMESPACE} --timeout=5m
                            kubectl get pods -n ${K8S_NAMESPACE}
                            kubectl get svc -n ${K8S_NAMESPACE}
                        """
                        echo "âœ… Application deployed to Kubernetes successfully"
                    } else {
                        echo "ğŸš€ Deploying with Docker..."
                        sh """
                            docker stop todo-node-app || true
                            docker rm todo-node-app || true
                            docker network create todo-network || true
                            docker run -d \
                                --name todo-node-app \
                                --network todo-network \
                                -p 8000:8000 \
                                -e NODE_ENV=production \
                                -e PORT=8000 \
                                --restart unless-stopped \
                                khushalbhavsar/${DOCKER_IMAGE}:${DOCKER_TAG}
                            sleep 5
                            docker ps
                        """
                        echo "âœ… Application deployed successfully"
                    }
                }
            }
        }
        stage("Health Check") {
            steps {
                echo "ğŸ¥ Performing application health check..."
                script {
                    if (env.DEPLOY_TARGET == "k8s") {
                        sh """
                            kubectl wait --for=condition=ready pod -l app=todoapp -n ${K8S_NAMESPACE} --timeout=300s
                            kubectl get svc ${K8S_DEPLOYMENT%-deployment}-service -n ${K8S_NAMESPACE}
                            kubectl get pods -n ${K8S_NAMESPACE} -l app=todoapp
                        """
                        echo "âœ… Kubernetes pods are running and healthy"
                    } else {
                        sh """
                            sleep 10
                            curl -f http://localhost:8000/health || exit 1
                        """
                        echo "âœ… Application is running and healthy"
                    }
                }
            }
        }
    }
    post {
        always {
            echo "ğŸ§¹ Cleaning up..."
            sh """
                docker logout || true
                docker image prune -f || true
            """
        }
        success {
            script {
                if (env.DEPLOY_TARGET == "k8s") {
                    echo """
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âœ… Pipeline Completed Successfully!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“¦ Build Number: ${BUILD_NUMBER}
            ğŸ³ Docker Image: khushalbhavsar/${DOCKER_IMAGE}:${DOCKER_TAG}
            â˜¸ï¸  Kubernetes Namespace: ${K8S_NAMESPACE}
            ğŸš€ Deployment: ${K8S_DEPLOYMENT}
            ğŸŒ Get Service URL: kubectl get svc -n ${K8S_NAMESPACE}
            ğŸ” SonarQube Report: Check SonarQube Dashboard
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
                } else {
                    echo """
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âœ… Pipeline Completed Successfully!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“¦ Build Number: ${BUILD_NUMBER}
            ğŸ³ Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}
            ğŸŒ Application: http://<EC2_IP>:8000
            ğŸ” SonarQube Report: Check SonarQube Dashboard
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
                }
            }
        }
        failure {
            script {
                if (env.DEPLOY_TARGET == "k8s") {
                    echo """
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âŒ Pipeline Failed!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“‹ Check logs above for details
            ğŸ” Build Number: ${BUILD_NUMBER}
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
                    sh """
                        kubectl get pods -n ${K8S_NAMESPACE} || true
                        kubectl describe deployment ${K8S_DEPLOYMENT} -n ${K8S_NAMESPACE} || true
                        kubectl logs -l app=todoapp -n ${K8S_NAMESPACE} --tail=50 || true
                    """
                } else {
                    echo """
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            âŒ Pipeline Failed!
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ğŸ“‹ Check logs above for details
            ğŸ” Build Number: ${BUILD_NUMBER}
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
                    sh """
                        docker logs todo-node-app || true
                        docker ps -a || true
                    """
                }
            }
        }
        unstable {
            echo "âš ï¸ Pipeline completed with warnings"
        }
    }
}
