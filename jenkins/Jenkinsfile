pipeline {
    agent any
    
    environment {
        // Docker Configuration
        DOCKER_IMAGE_BACKEND = 'productivity-backend'
        DOCKER_IMAGE_FRONTEND = 'productivity-frontend'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_HUB_CREDENTIALS = 'dockerhub-credentials'
        
        // SonarQube Configuration
        SONARQUBE_HOST = 'http://sonarqube:9000'
        SONARQUBE_CREDENTIALS = 'sonarqube-token'
        
        // Kubernetes Configuration
        K8S_NAMESPACE = 'productivity-tracker'
        K8S_DEPLOYMENT_BACKEND = 'backend'
        K8S_DEPLOYMENT_FRONTEND = 'frontend'
        KUBECONFIG = credentials('kubeconfig')
        
        // Deployment Target (initial value, will be dynamically determined)
        DEPLOY_TARGET = 'k8s'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo 'âœ… Code checkout completed'
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo 'ğŸ“¦ Installing dependencies...'
                    parallel(
                        'Backend Dependencies': {
                            dir('backend') {
                                sh 'npm ci'
                            }
                            echo 'âœ… Backend dependencies installed'
                        },
                        'Frontend Dependencies': {
                            dir('frontend') {
                                sh 'npm ci'
                            }
                            echo 'âœ… Frontend dependencies installed'
                        }
                    )
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    echo 'ğŸ§ª Running tests...'
                    try {
                        parallel(
                            'Backend Tests': {
                                dir('backend') {
                                    sh 'npm test || true'
                                }
                                echo 'âœ… Backend tests completed'
                            },
                            'Frontend Tests': {
                                dir('frontend') {
                                    sh 'npm test -- --watchAll=false || true'
                                }
                                echo 'âœ… Frontend tests completed'
                            }
                        )
                    } catch (Exception e) {
                        echo "âš ï¸ Some tests failed: ${e.message}"
                        echo "â„¹ï¸ Continuing pipeline..."
                    }
                }
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                script {
                    try {
                        echo "ğŸ” Running SonarQube code analysis..."
                        withCredentials([string(credentialsId: "${SONARQUBE_CREDENTIALS}", variable: 'SONAR_TOKEN')]) {
                            sh """
                                docker run --rm \
                                    --network host \
                                    -e SONAR_HOST_URL="${SONARQUBE_HOST}" \
                                    -e SONAR_TOKEN="\$SONAR_TOKEN" \
                                    -v "${WORKSPACE}:/usr/src" \
                                    sonarsource/sonar-scanner-cli \
                                    -Dsonar.projectKey=employee-productivity-tracker \
                                    -Dsonar.projectName='Employee Productivity & Task Tracker' \
                                    -Dsonar.projectVersion=1.0 \
                                    -Dsonar.sources=backend/src,frontend/src \
                                    -Dsonar.tests=backend/tests \
                                    -Dsonar.exclusions='**/node_modules/**,**/build/**,**/dist/**,**/*.test.js,**/*.spec.js,**/coverage/**' \
                                    -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info \
                                    -Dsonar.javascript.file.suffixes=.js,.jsx \
                                    -Dsonar.sourceEncoding=UTF-8
                            """
                        }
                        echo "âœ… SonarQube analysis completed"
                    } catch (Exception e) {
                        echo "âš ï¸ SonarQube analysis skipped: ${e.message}"
                        echo "ğŸ’¡ Check: 1) SonarQube server is running 2) Credential 'sonarqube-token' exists"
                        echo "â„¹ï¸ SonarQube URL: ${SONARQUBE_HOST}"
                    }
                }
            }
        }
        
        stage('Quality Gate') {
            steps {
                script {
                    try {
                        timeout(time: 5, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: true
                        }
                        echo "âœ… Quality Gate passed"
                    } catch (Exception e) {
                        echo "âš ï¸ Quality Gate check skipped (using Docker scanner)"
                        echo "ğŸ’¡ Visit ${SONARQUBE_HOST} to view detailed analysis results"
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            steps {
                script {
                    echo 'ğŸ—ï¸ Building Docker images...'
                    parallel(
                        'Build Backend': {
                            dir('backend') {
                                sh """
                                    docker build -t ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} .
                                    docker tag ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} ${DOCKER_IMAGE_BACKEND}:latest
                                """
                            }
                            echo "âœ… Backend image built: ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}"
                        },
                        'Build Frontend': {
                            dir('frontend') {
                                sh """
                                    docker build -t ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} .
                                    docker tag ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} ${DOCKER_IMAGE_FRONTEND}:latest
                                """
                            }
                            echo "âœ… Frontend image built: ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}"
                        }
                    )
                    echo 'âœ… All Docker images built successfully'
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                script {
                    try {
                        echo "ğŸ” Authenticating with Docker Hub..."
                        withCredentials([usernamePassword(
                            credentialsId: "${DOCKER_HUB_CREDENTIALS}",
                            usernameVariable: "DOCKER_USER", 
                            passwordVariable: "DOCKER_PASS")]) {
                            sh """
                                echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                                
                                # Push backend
                                docker tag ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} \$DOCKER_USER/${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}
                                docker tag ${DOCKER_IMAGE_BACKEND}:latest \$DOCKER_USER/${DOCKER_IMAGE_BACKEND}:latest
                                docker push \$DOCKER_USER/${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}
                                docker push \$DOCKER_USER/${DOCKER_IMAGE_BACKEND}:latest
                                
                                # Push frontend
                                docker tag ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} \$DOCKER_USER/${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}
                                docker tag ${DOCKER_IMAGE_FRONTEND}:latest \$DOCKER_USER/${DOCKER_IMAGE_FRONTEND}:latest
                                docker push \$DOCKER_USER/${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}
                                docker push \$DOCKER_USER/${DOCKER_IMAGE_FRONTEND}:latest
                            """
                        }
                        echo "âœ… Images pushed to Docker Hub successfully"
                    } catch (Exception e) {
                        echo "âš ï¸ Docker Hub push skipped: ${e.message}"
                        echo "ğŸ’¡ Local images available for deployment"
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    // Determine if EKS/Kubernetes is available
                    def eksAvailable = false
                    try {
                        sh 'kubectl get nodes'
                        eksAvailable = true
                        echo "â˜¸ï¸ Kubernetes (EKS) is available"
                    } catch (Exception e) {
                        eksAvailable = false
                        echo "âš ï¸ Kubernetes (EKS) not available, falling back to Docker deployment"
                    }

                    if (eksAvailable) {
                        echo "ğŸš€ Deploying to Kubernetes..."
                        withCredentials([usernamePassword(
                            credentialsId: "${DOCKER_HUB_CREDENTIALS}",
                            usernameVariable: "DOCKER_USER", 
                            passwordVariable: "DOCKER_PASS")]) {
                            sh """
                                kubectl apply -f kubernetes/namespace.yaml
                                kubectl apply -f kubernetes/configmaps/
                                kubectl apply -f kubernetes/secrets/
                                kubectl apply -f kubernetes/deployments/
                                kubectl apply -f kubernetes/services/
                                kubectl apply -f kubernetes/ingress/
                                kubectl apply -f kubernetes/hpa.yaml

                                kubectl set image deployment/${K8S_DEPLOYMENT_BACKEND} backend=\$DOCKER_USER/${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} -n ${K8S_NAMESPACE}
                                kubectl set image deployment/${K8S_DEPLOYMENT_FRONTEND} frontend=\$DOCKER_USER/${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} -n ${K8S_NAMESPACE}

                                kubectl rollout status deployment/${K8S_DEPLOYMENT_BACKEND} -n ${K8S_NAMESPACE} --timeout=5m
                                kubectl rollout status deployment/${K8S_DEPLOYMENT_FRONTEND} -n ${K8S_NAMESPACE} --timeout=5m
                            """
                        }
                        env.DEPLOY_TARGET = "k8s"
                        echo "âœ… Application deployed to Kubernetes successfully"
                    } else {
                        echo "ğŸš€ Deploying with Docker..."
                        sh """
                            docker stop productivity-backend productivity-frontend productivity-mongodb || true
                            docker rm productivity-backend productivity-frontend productivity-mongodb || true
                            docker network create productivity-network || true

                            docker run -d --name productivity-mongodb --network productivity-network -p 27017:27017 \
                                -e MONGO_INITDB_DATABASE=productivity-tracker -v mongodb_data:/data/db --restart unless-stopped mongo:7.0

                            sleep 5

                            docker run -d --name productivity-backend --network productivity-network -p 5000:5000 \
                                -e NODE_ENV=production -e PORT=5000 \
                                -e MONGODB_URI=mongodb://productivity-mongodb:27017/productivity-tracker \
                                -e JWT_SECRET=your-super-secret-jwt-key \
                                -e JWT_EXPIRE=7d --restart unless-stopped ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}

                            docker run -d --name productivity-frontend --network productivity-network -p 3000:80 \
                                -e REACT_APP_API_URL=http://localhost:5000/api --restart unless-stopped ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}

                            sleep 5
                            docker ps
                        """
                        env.DEPLOY_TARGET = "docker"
                        echo "âœ… Application deployed with Docker successfully"
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo "ğŸ¥ Verifying deployment and performing health checks..."
                    
                    if (env.DEPLOY_TARGET == "k8s") {
                        echo "â˜¸ï¸ Kubernetes deployment detected, checking pods and services..."
                        sh """
                            kubectl wait --for=condition=ready pod -l app=backend -n ${K8S_NAMESPACE} --timeout=300s
                            kubectl wait --for=condition=ready pod -l app=frontend -n ${K8S_NAMESPACE} --timeout=300s

                            kubectl get pods -n ${K8S_NAMESPACE}
                            kubectl get services -n ${K8S_NAMESPACE}
                            kubectl get ingress -n ${K8S_NAMESPACE}
                        """
                        echo "âœ… Kubernetes pods are running and healthy"
                    } else {
                        echo "ğŸ³ Docker deployment detected, checking containers..."
                        sh """
                            sleep 15
                            docker ps
                            curl -f http://localhost:5000/health || echo "âš ï¸ Backend health check pending..."
                        """
                        echo "âœ… Docker containers are running and healthy"
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ§¹ Cleaning up..."
            sh """
                docker logout || true
                docker image prune -f || true
            """
        }
        success {
            script {
                if (env.DEPLOY_TARGET == "k8s") {
                    echo """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Pipeline Completed Successfully!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Build Number: ${BUILD_NUMBER}
ğŸ³ Backend Image: ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}
ğŸ³ Frontend Image: ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}
â˜¸ï¸  Kubernetes Namespace: ${K8S_NAMESPACE}
ğŸš€ Backend Deployment: ${K8S_DEPLOYMENT_BACKEND}
ğŸš€ Frontend Deployment: ${K8S_DEPLOYMENT_FRONTEND}
ğŸŒ Get Service URL: kubectl get svc -n ${K8S_NAMESPACE}
ğŸ“Š Prometheus: kubectl get svc prometheus-service -n ${K8S_NAMESPACE}
ğŸ“ˆ Grafana: kubectl get svc grafana-service -n ${K8S_NAMESPACE}
ğŸ” SonarQube: ${SONARQUBE_HOST}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                } else {
                    echo """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… Pipeline Completed Successfully!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¦ Build Number: ${BUILD_NUMBER}
ğŸ³ Backend Image: ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}
ğŸ³ Frontend Image: ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}
ğŸŒ Frontend: http://localhost:3000
ğŸŒ Backend API: http://localhost:5000/api
ğŸ—„ï¸  MongoDB: localhost:27017
ğŸ“Š Prometheus: http://localhost:9090
ğŸ“ˆ Grafana: http://localhost:3001 (admin/admin)
ğŸ” SonarQube: ${SONARQUBE_HOST}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                }
            }
        }
        failure {
            script {
                echo """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ Pipeline Failed!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ Check logs above for details
ğŸ” Build Number: ${BUILD_NUMBER}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
                if (env.DEPLOY_TARGET == "k8s") {
                    sh """
                        echo "ğŸ” Kubernetes Diagnostics:"
                        kubectl get pods -n ${K8S_NAMESPACE} || true
                        kubectl describe deployment ${K8S_DEPLOYMENT_BACKEND} -n ${K8S_NAMESPACE} || true
                        kubectl describe deployment ${K8S_DEPLOYMENT_FRONTEND} -n ${K8S_NAMESPACE} || true
                        kubectl logs -l app=backend -n ${K8S_NAMESPACE} --tail=50 || true
                        kubectl logs -l app=frontend -n ${K8S_NAMESPACE} --tail=50 || true
                    """
                } else {
                    sh """
                        echo "ğŸ” Docker Diagnostics:"
                        docker logs productivity-backend --tail=50 || true
                        docker logs productivity-frontend --tail=50 || true
                        docker ps -a || true
                    """
                }
            }
        }
        unstable {
            echo "âš ï¸ Pipeline completed with warnings"
        }
    }
}
